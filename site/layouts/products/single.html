{{ define "main" }}

<style>
.product-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 2rem 1rem;
  text-align: center;
}

.product-hero-title {
  font-size: 2.4rem;
  font-weight: 700;
  margin-bottom: 1rem;
}

.product-description {
  font-size: 1.1rem;
  color: var(--muted);
  max-width: 650px;
  margin: 0.5rem auto 2rem;
}

.buy-button {
  display: inline-block;
  margin-top: 1.2rem;
  padding: 0.9rem 2.2rem;
  background: linear-gradient(135deg, var(--accent), #22c55e);
  color: white;
  border-radius: 999px;
  text-decoration: none;
  font-size: 1.1rem;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  border: none;
  cursor: pointer;
}

.buy-button:hover {
  filter: brightness(1.08);
}

.buy-error {
  margin-top: 0.75rem;
  font-size: 0.9rem;
  color: #f97373;
}

.section-title {
  margin-top: 3rem;
  font-size: 1.8rem;
  font-weight: 600;
}

.article-list {
  margin-top: 1.5rem;
  list-style: none;
  padding: 0;
}

.article-list li {
  margin: 0.4rem 0;
  font-size: 1.05rem;
}
</style>

<div class="product-container">

  <h1 class="product-hero-title">{{ .Title }}</h1>

  <p class="product-description">
    {{ with .Params.description }}
      {{ . }}
    {{ else }}
      {{ .Summary }}
    {{ end }}
  </p>

  {{/* Preislabel: erst price_label, fallback price_eur */}}
  {{ $priceLabel := "" }}
  {{ if .Params.price_label }}
    {{ $priceLabel = .Params.price_label }}
  {{ else if .Params.price_eur }}
    {{ $priceLabel = printf "%d €" .Params.price_eur }}
  {{ else }}
    {{ $priceLabel = "Jetzt kaufen" }}
  {{ end }}

  {{/* Pack-Slug: bevorzugt slug, fallback pack_slug (Kompatibilität) */}}
  {{ $packSlug := "" }}
  {{ if .Params.slug }}
    {{ $packSlug = .Params.slug }}
  {{ else if .Params.pack_slug }}
    {{ $packSlug = .Params.pack_slug }}
  {{ end }}

  <!-- BUY BUTTON (JS-Checkout über /api/checkout/session) -->
  <button
    id="buy-button"
    class="buy-button"
    type="button"
    data-pack-slug="{{ $packSlug }}"
  >
    Kaufen – {{ $priceLabel }}
  </button>

  <p id="buy-error" class="buy-error" style="display:none;"></p>

  <!-- CONTENT SECTION -->
  <h2 class="section-title">Was ist im Pack enthalten?</h2>

  <div class="product-description" style="margin-bottom: 1.5rem;">
    {{ .Content }}
  </div>

</div>

<script>
(function() {
  const btn = document.getElementById("buy-button");
  if (!btn) return;

  const packSlug = btn.dataset.packSlug;
  const errorEl = document.getElementById("buy-error");

  // Backend-URL aus Hugo config.toml
  const backendBaseRaw = "{{ .Site.Params.backendBaseURL }}";
  const backendBaseUrl = backendBaseRaw.replace(/\/$/, "");

  if (!packSlug) {
    if (errorEl) {
      errorEl.style.display = "block";
      errorEl.textContent = "Fehlende Pack-Slug-Konfiguration.";
    }
    btn.disabled = true;
    return;
  }

  if (!backendBaseUrl) {
    if (errorEl) {
      errorEl.style.display = "block";
      errorEl.textContent = "Backend-URL ist nicht konfiguriert.";
    }
    btn.disabled = true;
    return;
  }

  async function fetchPackJson() {
    const res = await fetch(`/packs/${packSlug}.json`, { cache: "no-store" });
    if (!res.ok) {
      throw new Error(`Pack-JSON nicht gefunden: /packs/${packSlug}.json`);
    }
    return await res.json();
  }

  async function createCheckoutSession(priceId) {
    const res = await fetch(`${backendBaseUrl}/api/checkout/session`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        price_id: priceId,
        pack_slug: packSlug
      })
    });

    if (!res.ok) {
      let err;
      try { err = await res.json(); } catch (_) {}
      throw new Error(err?.detail || `Checkout-Fehler (HTTP ${res.status})`);
    }

    return await res.json();
  }

  btn.addEventListener("click", async () => {
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "Weiter zum Checkout …";
    if (errorEl) {
      errorEl.style.display = "none";
      errorEl.textContent = "";
    }

    try {
      const pack = await fetchPackJson();
      const priceId = pack.stripe_price_id;
      if (!priceId) {
        throw new Error("Für dieses Pack ist kein stripe_price_id konfiguriert.");
      }

      const session = await createCheckoutSession(priceId);
      if (!session.url) {
        throw new Error("Backend hat keine Checkout-URL zurückgegeben.");
      }

      window.location.href = session.url;
    } catch (err) {
      console.error(err);
      if (errorEl) {
        errorEl.style.display = "block";
        errorEl.textContent = err.message;
      } else {
        alert("Checkout-Fehler: " + err.message);
      }
      btn.disabled = false;
      btn.innerText = originalText;
    }
  });
})();
</script>

{{ end }}
